@page "/view-euser"

@using MauiApp1
@inject UserService UserService
@layout Layoutminu
@inject UserService userService
@inject DialogService DialogService
@inject NavigationManager NavigationManager
@inject Blazored.LocalStorage.ILocalStorageService localStorage

<h3 style="text-align:center; font-size:20px;">👤 جدول الزباين </h3>

<div style="overflow-x:auto; padding:10px;">
    <RadzenDataGrid Data="@users" TItem="User"
                    ColumnWidth="80px"
                    Style="width:100%; background-color:#FFF4E5; border:1px solid #FFA500; color:#000; font-family:'Segoe UI', sans-serif;">
        <Columns>
            <RadzenDataGridColumn TItem="User" Property="id" Title="🔢 رقم الزبون" />
            <RadzenDataGridColumn TItem="User" Property="name" Title="👤 الاسم " />
            <RadzenDataGridColumn TItem="User" Property="password" Title="🔐 الرقم السري" />
            <RadzenDataGridColumn TItem="User" Property="number" Title="📱 رقم الهاتف" />
            @if (xa == true && xs == true)
            {
                <RadzenDataGridColumn TItem="User" Title="مشرف">
                    <Template Context="user">
                        @if (user.adminsampil == true)
                        {
                            <span style="color:green;">✅</span>
                        }
                        else
                        {
                            <span style="color:red;">❌</span>
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="User" Title="مسؤل">
                    <Template Context="user">
                        @if (user.adminall == true)
                        {
                            <span style="color:green;">✅</span>
                        }
                        else
                        {
                            <span style="color:red;">❌</span>
                        }
                    </Template>
                </RadzenDataGridColumn>
            }
            else if (xs == true)
            {
                <RadzenDataGridColumn TItem="User" Title="مشرف">
                    <Template Context="user">
                        @if (user.adminsampil == true)
                        {
                            <span style="color:green;">✅</span>
                        }
                        else
                        {
                            <span style="color:red;">❌</span>
                        }
                    </Template>
                </RadzenDataGridColumn>
            }
        </Columns>
    </RadzenDataGrid>

    <h3 style="text-align:center;">✏ تعديل بيانات الموظف حسب رقم الهاتف</h3>

    <div style="display: flex; justify-content: center;">
        <div style="width: 100%; max-width: 500px;">
            <RadzenTemplateForm Data="@user" TItem="User" Submit="@UpdateUser">
                <RadzenNumeric TValue="int" @bind-Value="searchNumber" Placeholder="🔢 رقم الموظف" Style="width: 100%;" />

                <div class="d-flex gap-2 mt-3">
                    <RadzenButton Text="🔍 جلب البيانات" Click="@FetchUser" Style="width: 49%; background-color:orange" />
                    <RadzenButton Text="🗑️ حذف" Click="@DeleteUser" ButtonType="ButtonType.Button" Style="width: 49%; background-color:#c82333; color:white;" />
                </div>

                @if (userFound)
                {
                    <RadzenTextBox @bind-Value="user.name" Placeholder="👤 الاسم" Style="width: 100%;" Class="mt-3" />
                    <RadzenPassword @bind-Value="user.password" Placeholder="🔐 كلمة السر" Style="width: 100%;" Class="mt-3" />
                    <RadzenNumeric TValue="int" @bind-Value="user.number" Placeholder="📱 رقم الهاتف" Style="width: 100%;" Class="mt-3" />

                    <RadzenCheckBox @bind-Value="user.adminsampil" Style="margin-top:10px;" />
                    <label style="margin-left: 5px;">📋 صلاحية جزئية</label>

                    <RadzenCheckBox @bind-Value="user.adminall" Style="margin-top:10px;" />
                    <label style="margin-left: 5px;">🔐 صلاحية كاملة</label>

                    <RadzenButton Text="💾 تحديث البيانات" Icon="save" ButtonType="ButtonType.Submit" Class="mt-3" Style="width: 100%; background-color:orange" />
                }
                else if (searched)
                {
                    <p class="text-danger mt-3">🔍 لم يتم العثور على موظف يحمل رقم الهاتف المدخل</p>
                }

                @if (!string.IsNullOrEmpty(a))
                {
                    <p style="color:red;">@a</p>
                }
                @if (!string.IsNullOrEmpty(b))
                {
                    <p style="color:green;">@b</p>
                }
            </RadzenTemplateForm>
        </div>
    </div>
</div>

@code {


    List<User> users = new();
    string a;
    string b;
    bool? xs;
    bool? xa;
    protected override async Task OnInitializedAsync()
    {
        xs = await localStorage.GetItemAsync<bool?>("Adminsampil");
        xa = await localStorage.GetItemAsync<bool?>("Adminall");
        await UserService.InitAsync();
        users = (await UserService.GetUsersAsync())
            .Where(u => u.adminall == true ||u.adminsampil== true) 
            .OrderByDescending(u => u.id)
            .ToList();
    }

    private int searchNumber;
    private User user = new();
    private bool userFound = false;
    private bool searched = false;

    private async Task LoadUsers()
    {
        users = (await userService.GetUsersAsync())
                   .OrderByDescending(u => u.id)
                   .ToList();
        StateHasChanged();
    }

    private async Task FetchUser()
    {
        user = await userService.GetUserByNumberAsync(searchNumber) ?? new();
        userFound = user.id != null;
        searched = true;

        if (!userFound)
        {
            a = "🔍 لم يتم العثور على موظف يحمل رقم الهاتف المدخل";
            b = string.Empty;
        }
        else
        {
            a = string.Empty;
            b = string.Empty;
        }
    }

    private async Task UpdateUser()
    {
        if (user.id == null)
        {
            a = "🚫 الرجاء اختيار موظف قبل إجراء التحديث";
            b = string.Empty;
            return;
        }

        await userService.UpdateUserAsync(user);
        b = "📋 تم حفظ التعديلات على بيانات الموظف بنجاح";
        a = string.Empty;
        await LoadUsers();
    }

    private async Task DeleteUser()
    {
        if (searchNumber == 0)
        {
            a = "⚠️ الرجاء إدخال رقم الموظف قبل محاولة الحذف";
            b = string.Empty;
            return;
        }

        var userToDelete = await userService.GetUserByNumberAsync(searchNumber);

        if (userToDelete?.id != null)
        {
            await userService.DeleteUserAsync(userToDelete);
            user = new();
            userFound = false;
            searched = false;
            a = string.Empty;
            b = "🧹 تم حذف الموظف من النظام بنجاح";
        }
        else
        {
            userFound = false;
            searched = true;
            a = "📭 لا يوجد موظف مسجل بهذا الرقم حالياً";
            b = string.Empty;
        }

        await LoadUsers();
    }
}